先推式子。

令 $L(n,k)$ 为最长区块长度为 $k$ 的方案数，则 $Ans=\sum_{i=0}^n\limits{L(n,i)}\times k$。下面转为求 $L(n,k)$。

我们考虑可能的区块长度分别为多少。那么就相当于我们要枚举所有的长度在 $1\sim k$ 之间的区块，他们长度的和为 $n$。据此我们枚举区块数量，先写出 $L(n,k)=\sum_{i=0}^n\limits{(g(n,i,k)-g(n,i,k-1))\times ???}$。

考虑后面的部分应该是什么。粗略一看，似乎我们只需要指定区块间的相对大小，我们就能生成一个排列，因此后面是 $i!$，但实际上这是错误的。我们希望我们生成的 $i$ 个区间不会退化，即相邻两个区间合并到了一起变成了一个区间。而这需要保证我们区间的相对顺序所构成的一个 $1\sim i$ 的排列最长区间为 $1$。因此后面的部分是 $L(i,1)$，据此写出公式 $L(n,k)=\sum_{i=0}^n\limits{(g(n,i,k)-g(n,i,k-1))\times L(i,1)}$，其中 $g(n,i,k)$ 表示在 $1\sim k$ 中选 $i$ 个可重复的数，且和为 $n$。  

下面转求 $h(n)=L(n,1)$。我们枚举规模较小的情况，不难猜想 $h(n)=d[n]+d[n-1]$，其中 $d$ 是错位重排数。  
实际上这也可以归纳证明：假设 $h(n)=d[n]+d[n-1]$，那么对于$h(n+1)$，考虑递推，我们发现 $n+1$ 这个数对于每个排列都有 $n$ 个合理的插入位置，即除了 $n$ 后边的所有位置。再结合 $ d[n]=n\times d[n-1] + (-1)^n $，结论是显然的了。  
另一方面也可以考虑其组合意义，对于 $h(n)$，在插入 $n$ 时，要么原本就合法，则此时有 $h(n−1)\times(n−1)$ 种方案；要么原本有一对不合法，则把 $n$ 插在两者中间，那么把这一对数看作一个，方案数有 $h(n−2)\times(n−2)$ 种。把二者加和，这显然实际上就是 $d[n]+d[n−1]$，虽然即使并不承认这一点也可以用递推式来预处理出 $h$。  
结合此结论，得到$L(n,k)=\sum_{i=0}^n\limits{(g(n,i,k)-g(n,i,k-1))\times (d[i]+d[i-1])}$。这就是我们心心念念的 $L$。

考虑如何计算。首先考虑 $g$ 的组合意义，我们发现，若 $ik\le n$，直接置 $g(n,i,k)=0$ 即可。那么对于剩下的情况，我们考虑其组合意义，并用插板法容斥得到公式 $g(n,i,k)=\sum_{x=0}^i\limits{(-1)^x\binom{n-xk-1}{i-1} \binom{i}{x}}$，对组合数预处理以后控制 $x$ 的上界，可以 $O(n^2\log n)$ 求出结果。   

出题人起初给出的代码跑的奇慢无比，发现是因为出题人一些奇怪的习惯导致常数飞天。后来重新写了一个 std，常数略小。 